<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="task5.css">
    <title>dojo 中間課題</title>
  </head>
  <body>
    <h1><span id="titleLeft">「自分のHPで、APIで取得したデータをもとに。</span>
    <span id="titleRight">最新情報を表示するようなサイトを作りたい」</span></h1>
    <script src="https://js.cybozu.com/axios/v0.27.2/axios.min.js"></script>  
    <table id="addNews">
    </table>
    <script>

      const apiUrl = 'https://54o76ppvn8.execute-api.ap-northeast-1.amazonaws.com/prod/bb-dojo';
      
      const tablecreator = (day, category, content, url, targ) => {
        const trEle = document.createElement('tr');
        const tdDay = document.createElement('td');
        tdDay.textContent = day;
        trEle.appendChild(tdDay);
        const tdCategory = document.createElement('td');
        tdCategory.textContent = category;
        switch (category) {
          case '製品':
            tdCategory.className = 'product';
            break;
          case 'IR 情報':
            tdCategory.className = 'ir';
            break;
          case '企業情報':
            tdCategory.className = 'comparny';
            break;
        }
        trEle.appendChild(tdCategory);
        const tdContent = document.createElement('td');
        const urlEle = document.createElement('a');
        urlEle.href = url;
        if (targ === '_self') {
          urlEle.target = '_self';
        } else {
          urlEle.target = '_brank';
        }
        const formattedcontent = strChanger(content);
        urlEle.innerText = formattedcontent;
        tdContent.appendChild(urlEle);
        trEle.appendChild(tdContent);
        const addNews = document.getElementById('addNews');
        addNews.appendChild(trEle);
      };

      const strChanger = (str) => {
        const strNum = str.length;
        if (strNum >= 30) {
          str = str.substr(0, 30);
          str += '...';
          return str;
        } else {
          return str;
        }
      };

      const waitFunc =(async () => {
        let apiexe = axios.get(apiUrl, {
          params: {
            id: 'dojo',
            query: 'order by day desc limit 3',
          }
        })
        .then(async(reps) => {
          for (let i = 0; i < reps.data.length; i++) {
            const tdday = reps.data[i].day.value;
            const tdcate = reps.data[i].category.value;
            const tdcont = reps.data[i].content.value;
            const tdurl = reps.data[i].url.value;
            const tdtarget = reps.data[i].target.value;
            tablecreator(tdday, tdcate, tdcont, tdurl, tdtarget);
          }
        })
        .catch((err) => {
          window.alert('読み込みエラーが発生しました。ページを開きなおしてください。\n何度も表示された場合は、コンソールをご覧ください。');
          console.log('下記のエラーが発生しました↓');
          console.log(err);
        });
        await apiexe;
      });

      waitFunc();
    </script>
  </body>
</html>